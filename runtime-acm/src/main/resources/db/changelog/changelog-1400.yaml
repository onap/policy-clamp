# ============LICENSE_START=======================================================
# Copyright (C) 2025 OpenInfra Foundation Europe. All rights reserved.
# ================================================================================
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0
# ============LICENSE_END=========================================================

databaseChangeLog:
  - objectQuotingStrategy: QUOTE_ONLY_RESERVED_WORDS

  - changeSet:
      id: 1400-1
      author: policy
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: AutomationComposition
      changes:
        - createTable:
            tableName: AutomationComposition
            columns:
              - column:
                  name: instanceId
                  type: VARCHAR(255)
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_automationcomposition
                    nullable: false
              - column:
                  name: compositionId
                  type: VARCHAR(255)
              - column:
                  name: compositionTargetId
                  type: VARCHAR(255)
              - column:
                  name: deployState
                  type: SMALLINT
              - column:
                  name: description
                  type: VARCHAR(255)
              - column:
                  name: lockState
                  type: SMALLINT
              - column:
                  name: name
                  type: VARCHAR(255)
              - column:
                  name: restarting
                  type: BOOLEAN
              - column:
                  name: stateChangeResult
                  type: SMALLINT
              - column:
                  name: version
                  type: VARCHAR(255)

  - changeSet:
      id: 1400-2
      author: policy
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: AutomationCompositionDefinition
      changes:
        - createTable:
            tableName: AutomationCompositionDefinition
            columns:
              - column:
                  name: compositionId
                  type: VARCHAR(255)
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_automationcompositiondefinition
                    nullable: false
              - column:
                  name: name
                  type: VARCHAR(255)
              - column:
                  name: restarting
                  type: BOOLEAN
              - column:
                  name: serviceTemplate
                  type: TEXT
              - column:
                  name: state
                  type: SMALLINT
              - column:
                  name: stateChangeResult
                  type: SMALLINT
              - column:
                  name: version
                  type: VARCHAR(255)

  - changeSet:
      id: 1400-3
      author: policy
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: AutomationCompositionElement
      changes:
        - createTable:
            tableName: AutomationCompositionElement
            columns:
              - column:
                  name: elementId
                  type: VARCHAR(255)
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_automationcompositionelement
                    nullable: false
              - column:
                  name: definition_name
                  type: VARCHAR(255)
              - column:
                  name: definition_version
                  type: VARCHAR(255)
              - column:
                  name: deployState
                  type: SMALLINT
              - column:
                  name: description
                  type: VARCHAR(255)
              - column:
                  name: instanceId
                  type: VARCHAR(255)
              - column:
                  name: lockState
                  type: SMALLINT
              - column:
                  name: message
                  type: VARCHAR(255)
              - column:
                  name: operationalState
                  type: VARCHAR(255)
              - column:
                  name: outProperties
                  type: TEXT
              - column:
                  name: participantId
                  type: VARCHAR(255)
              - column:
                  name: properties
                  type: TEXT
              - column:
                  name: restarting
                  type: BOOLEAN
              - column:
                  name: useState
                  type: VARCHAR(255)

  - changeSet:
      id: 1400-4
      author: policy
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: NodeTemplateState
      changes:
        - createTable:
            tableName: NodeTemplateState
            columns:
              - column:
                  name: nodeTemplateStateId
                  type: VARCHAR(255)
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_nodetemplatestate
                    nullable: false
              - column:
                  name: compositionId
                  type: VARCHAR(255)
              - column:
                  name: message
                  type: VARCHAR(255)
              - column:
                  name: nodeTemplate_name
                  type: VARCHAR(255)
              - column:
                  name: nodeTemplate_version
                  type: VARCHAR(255)
              - column:
                  name: outProperties
                  type: TEXT
              - column:
                  name: participantId
                  type: VARCHAR(255)
              - column:
                  name: restarting
                  type: BOOLEAN
              - column:
                  name: state
                  type: SMALLINT

  - changeSet:
      id: 1400-5
      author: policy
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: Participant
      changes:
        - createTable:
            tableName: Participant
            columns:
              - column:
                  name: participantId
                  type: VARCHAR(255)
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_participant
                    nullable: false
              - column:
                  name: description
                  type: VARCHAR(255)
              - column:
                  name: participantState
                  type: SMALLINT

  - changeSet:
      id: 1400-6
      author: policy
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: ParticipantSupportedAcElements
      changes:
        - createTable:
            tableName: ParticipantSupportedAcElements
            columns:
              - column:
                  name: id
                  type: VARCHAR(255)
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_participantsupportedacelements
                    nullable: false
              - column:
                  name: participantId
                  type: VARCHAR(255)
              - column:
                  name: typeName
                  type: VARCHAR(255)
              - column:
                  name: typeVersion
                  type: VARCHAR(255)

  - changeSet:
      id: 1400-7
      author: policy
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: ac_compositionId
      changes:
        - createIndex:
            indexName: ac_compositionId
            tableName: AutomationComposition
            columns:
              - column:
                  name: compositionId

  - changeSet:
      id: 1400-8
      author: policy
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: ac_element_fk
      changes:
        - createIndex:
            indexName: ac_element_fk
            tableName: AutomationCompositionElement
            columns:
              - column:
                  name: instanceId

  - changeSet:
      id: 1400-9
      author: policy
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: dt_element_fk
      changes:
        - createIndex:
            indexName: dt_element_fk
            tableName: NodeTemplateState
            columns:
              - column:
                  name: compositionId

  - changeSet:
      id: 1400-10
      author: policy
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: supported_element_fk
      changes:
        - createIndex:
            indexName: supported_element_fk
            tableName: ParticipantSupportedAcElements
            columns:
              - column:
                  name: participantId

  - changeSet:
      id: 1400-11
      author: policy
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: ac_element_fk
                foreignKeyTableName: AutomationCompositionElement
      changes:
        - addForeignKeyConstraint:
            baseTableName: AutomationCompositionElement
            baseColumnNames: instanceId
            constraintName: ac_element_fk
            referencedTableName: AutomationComposition
            referencedColumnNames: instanceId
            onUpdate: RESTRICT
            onDelete: RESTRICT

  - changeSet:
      id: 1400-12
      author: policy
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: dt_element_fk
                foreignKeyTableName: NodeTemplateState
      changes:
        - addForeignKeyConstraint:
            baseTableName: NodeTemplateState
            baseColumnNames: compositionId
            constraintName: dt_element_fk
            referencedTableName: AutomationCompositionDefinition
            referencedColumnNames: compositionId
            onUpdate: RESTRICT
            onDelete: RESTRICT

  - changeSet:
      id: 1400-13
      author: policy
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: supported_element_fk
                foreignKeyTableName: ParticipantSupportedAcElements
      changes:
        - addForeignKeyConstraint:
            baseTableName: ParticipantSupportedAcElements
            baseColumnNames: participantId
            constraintName: supported_element_fk
            referencedTableName: Participant
            referencedColumnNames: participantId
            onUpdate: RESTRICT
            onDelete: RESTRICT
