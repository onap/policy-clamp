# ============LICENSE_START=======================================================
# Copyright (C) 2025 OpenInfra Foundation Europe. All rights reserved.
# ================================================================================
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0
# ============LICENSE_END=========================================================

databaseChangeLog:
  - objectQuotingStrategy: QUOTE_ONLY_RESERVED_WORDS

  - changeSet:
      id: 1701-1
      author: policy
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: AutomationCompositionRollback
      changes:
        - createTable:
            tableName: AutomationCompositionRollback
            columns:
              - column:
                  name: instanceId
                  type: VARCHAR(255)
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_automationcomposition_rollback
                    nullable: false
              - column:
                  name: compositionId
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: elements
                  type: TEXT
                  constraints:
                    nullable: false

  - changeSet:
      id: 1701-2
      author: policy
      changes:
        - addNotNullConstraint:
            tableName: AutomationComposition
            columnName: compositionId

  - changeSet:
      id: 1701-3
      author: policy
      changes:
        - addDefaultValue:
            tableName: AutomationComposition
            columnName: name
            defaultValue: ''
        - update:
            tableName: AutomationComposition
            columns:
              - column:
                  name: name
                  value: ''
            where: name IS NULL
        - addNotNullConstraint:
            tableName: AutomationComposition
            columnName: name

  - changeSet:
      id: 1701-4
      author: policy
      changes:
        - addDefaultValue:
            tableName: AutomationComposition
            columnName: version
            defaultValue: '1.0.0'
        - update:
            tableName: AutomationComposition
            columns:
              - column:
                  name: version
                  value: '1.0.0'
            where: version IS NULL
        - addNotNullConstraint:
            tableName: AutomationComposition
            columnName: version

  - changeSet:
      id: 1701-5
      author: policy
      changes:
        - addDefaultValue:
            tableName: AutomationComposition
            columnName: deployState
            defaultValueNumeric: 2
        - update:
            tableName: AutomationComposition
            columns:
              - column:
                  name: deployState
                  valueNumeric: 2
            where: deployState IS NULL
        - addNotNullConstraint:
            tableName: AutomationComposition
            columnName: deployState

  - changeSet:
      id: 1701-6
      author: policy
      changes:
        - addDefaultValue:
            tableName: AutomationComposition
            columnName: lockState
            defaultValueNumeric: 4
        - update:
            tableName: AutomationComposition
            columns:
              - column:
                  name: lockState
                  valueNumeric: 4
            where: lockState IS NULL
        - addNotNullConstraint:
            tableName: AutomationComposition
            columnName: lockState

  - changeSet:
      id: 1701-7
      author: policy
      changes:
        - addDefaultValue:
            tableName: AutomationComposition
            columnName: subState
            defaultValueNumeric: 0
        - update:
            tableName: AutomationComposition
            columns:
              - column:
                  name: subState
                  valueNumeric: 0
            where: subState IS NULL
        - addNotNullConstraint:
            tableName: AutomationComposition
            columnName: subState

  - changeSet:
      id: 1701-8
      author: policy
      changes:
        - update:
            tableName: AutomationComposition
            columns:
              - column:
                  name: lastMsg
                  valueComputed: CURRENT_TIMESTAMP
            where: lastMsg IS NULL
        - addNotNullConstraint:
            tableName: AutomationComposition
            columnName: lastMsg

  - changeSet:
      id: 1701-9
      author: policy
      changes:
        - addDefaultValue:
            tableName: AutomationCompositionElement
            columnName: definition_name
            defaultValue: ''
        - update:
            tableName: AutomationCompositionElement
            columns:
              - column:
                  name: definition_name
                  value: ''
            where: definition_name IS NULL
        - addNotNullConstraint:
            tableName: AutomationCompositionElement
            columnName: definition_name

  - changeSet:
      id: 1701-10
      author: policy
      changes:
        - addDefaultValue:
            tableName: AutomationCompositionElement
            columnName: definition_version
            defaultValue: '0.0.0'
        - update:
            tableName: AutomationCompositionElement
            columns:
              - column:
                  name: definition_version
                  value: '0.0.0'
            where: definition_version IS NULL
        - addNotNullConstraint:
            tableName: AutomationCompositionElement
            columnName: definition_version

  - changeSet:
      id: 1701-11
      author: policy
      changes:
        - addDefaultValue:
            tableName: AutomationCompositionElement
            columnName: deployState
            defaultValueNumeric: 2
        - update:
            tableName: AutomationCompositionElement
            columns:
              - column:
                  name: deployState
                  valueNumeric: 2
            where: deployState IS NULL
        - addNotNullConstraint:
            tableName: AutomationCompositionElement
            columnName: deployState

  - changeSet:
      id: 1701-12
      author: policy
      changes:
        - addDefaultValue:
            tableName: AutomationCompositionElement
            columnName: lockState
            defaultValueNumeric: 4
        - update:
            tableName: AutomationCompositionElement
            columns:
              - column:
                  name: lockState
                  valueNumeric: 4
            where: lockState IS NULL
        - addNotNullConstraint:
            tableName: AutomationCompositionElement
            columnName: lockState

  - changeSet:
      id: 1701-13
      author: policy
      changes:
        - addDefaultValue:
            tableName: AutomationCompositionElement
            columnName: subState
            defaultValueNumeric: 0
        - update:
            tableName: AutomationCompositionElement
            columns:
              - column:
                  name: subState
                  valueNumeric: 0
            where: subState IS NULL
        - addNotNullConstraint:
            tableName: AutomationCompositionElement
            columnName: subState

  - changeSet:
      id: 1701-14
      author: policy
      changes:
        - addDefaultValue:
            tableName: AutomationCompositionElement
            columnName: outProperties
            defaultValue: '{}'
        - update:
            tableName: AutomationCompositionElement
            columns:
              - column:
                  name: outProperties
                  value: '{}'
            where: outProperties IS NULL
        - addNotNullConstraint:
            tableName: AutomationCompositionElement
            columnName: outProperties

  - changeSet:
      id: 1701-15
      author: policy
      changes:
        - addDefaultValue:
            tableName: AutomationCompositionElement
            columnName: properties
            defaultValue: '{}'
        - update:
            tableName: AutomationCompositionElement
            columns:
              - column:
                  name: properties
                  value: '{}'
            where: properties IS NULL
        - addNotNullConstraint:
            tableName: AutomationCompositionElement
            columnName: properties

  - changeSet:
      id: 1701-16
      author: policy
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: ac_composition_fk
                foreignKeyTableName: AutomationComposition
      changes:
        - addForeignKeyConstraint:
            baseTableName: AutomationComposition
            baseColumnNames: compositionId
            constraintName: ac_composition_fk
            referencedTableName: AutomationCompositionDefinition
            referencedColumnNames: compositionId
            onUpdate: RESTRICT
            onDelete: RESTRICT

  - changeSet:
      id: 1701-17
      author: policy
      changes:
        - addDefaultValue:
            tableName: AutomationCompositionDefinition
            columnName: name
            defaultValue: ''
        - update:
            tableName: AutomationCompositionDefinition
            columns:
              - column:
                  name: name
                  value: ''
            where: name IS NULL
        - addNotNullConstraint:
            tableName: AutomationCompositionDefinition
            columnName: name

  - changeSet:
      id: 1701-18
      author: policy
      changes:
        - addDefaultValue:
            tableName: AutomationCompositionDefinition
            columnName: version
            defaultValue: '1.0.0'
        - update:
            tableName: AutomationCompositionDefinition
            columns:
              - column:
                  name: version
                  value: '1.0.0'
            where: version IS NULL
        - addNotNullConstraint:
            tableName: AutomationCompositionDefinition
            columnName: version

  - changeSet:
      id: 1701-19
      author: policy
      changes:
        - addDefaultValue:
            tableName: AutomationCompositionDefinition
            columnName: state
            defaultValueNumeric: 0
        - update:
            tableName: AutomationCompositionDefinition
            columns:
              - column:
                  name: state
                  valueNumeric: 0
            where: state IS NULL
        - addNotNullConstraint:
            tableName: AutomationCompositionDefinition
            columnName: state

  - changeSet:
      id: 1701-20
      author: policy
      changes:
        - addDefaultValue:
            tableName: AutomationCompositionDefinition
            columnName: serviceTemplate
            defaultValue: ''
        - update:
            tableName: AutomationCompositionDefinition
            columns:
              - column:
                  name: serviceTemplate
                  value: ''
            where: serviceTemplate IS NULL
        - addNotNullConstraint:
            tableName: AutomationCompositionDefinition
            columnName: serviceTemplate

  - changeSet:
      id: 1701-21
      author: policy
      changes:
        - update:
            tableName: AutomationCompositionDefinition
            columns:
              - column:
                  name: lastMsg
                  valueComputed: CURRENT_TIMESTAMP
            where: lastMsg IS NULL
        - addNotNullConstraint:
            tableName: AutomationCompositionDefinition
            columnName: lastMsg

  - changeSet:
      id: 1701-22
      author: policy
      changes:
        - addDefaultValue:
            tableName: NodeTemplateState
            columnName: nodeTemplate_name
            defaultValue: ''
        - update:
            tableName: NodeTemplateState
            columns:
              - column:
                  name: nodeTemplate_name
                  value: ''
            where: nodeTemplate_name IS NULL
        - addNotNullConstraint:
            tableName: NodeTemplateState
            columnName: nodeTemplate_name

  - changeSet:
      id: 1701-23
      author: policy
      changes:
        - addDefaultValue:
            tableName: NodeTemplateState
            columnName: nodeTemplate_version
            defaultValue: '1.0.0'
        - update:
            tableName: NodeTemplateState
            columns:
              - column:
                  name: nodeTemplate_version
                  value: '1.0.0'
            where: nodeTemplate_version IS NULL
        - addNotNullConstraint:
            tableName: NodeTemplateState
            columnName: nodeTemplate_version

  - changeSet:
      id: 1701-24
      author: policy
      changes:
        - addDefaultValue:
            tableName: NodeTemplateState
            columnName: outProperties
            defaultValue: '{}'
        - update:
            tableName: NodeTemplateState
            columns:
              - column:
                  name: outProperties
                  value: '{}'
            where: outProperties IS NULL
        - addNotNullConstraint:
            tableName: NodeTemplateState
            columnName: outProperties

  - changeSet:
      id: 1701-25
      author: policy
      changes:
        - addDefaultValue:
            tableName: NodeTemplateState
            columnName: state
            defaultValueNumeric: 0
        - update:
            tableName: NodeTemplateState
            columns:
              - column:
                  name: state
                  valueNumeric: 0
            where: state IS NULL
        - addNotNullConstraint:
            tableName: NodeTemplateState
            columnName: state

  - changeSet:
      id: 1701-26
      author: policy
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: mb_identificationId_index
      changes:
        - createIndex:
            tableName: Message
            indexName: mb_identificationId_index
            columns:
              - column:
                  name: identificationId

  - changeSet:
      id: 1701-27
      author: policy
      changes:
        - update:
            tableName: ParticipantReplica
            columns:
              - column:
                  name: lastMsg
                  valueComputed: CURRENT_TIMESTAMP
            where: lastMsg IS NULL
        - addNotNullConstraint:
            tableName: ParticipantReplica
            columnName: lastMsg

  - changeSet:
      id: 1701-28
      author: policy
      changes:
        - addDefaultValue:
            tableName: ParticipantReplica
            columnName: participantId
            defaultValue: ''
        - addNotNullConstraint:
            tableName: ParticipantReplica
            columnName: participantId

  - changeSet:
      id: 1701-29
      author: policy
      changes:
        - addDefaultValue:
            tableName: ParticipantReplica
            columnName: participantState
            defaultValueNumeric: 1
        - update:
            tableName: ParticipantReplica
            columns:
              - column:
                  name: participantState
                  valueNumeric: 1
            where: participantState IS NULL
        - addNotNullConstraint:
            tableName: ParticipantReplica
            columnName: participantState

  - changeSet:
      id: 1701-30
      author: policy
      changes:
        - addDefaultValue:
            tableName: ParticipantSupportedAcElements
            columnName: participantId
            defaultValue: ''
        - addNotNullConstraint:
            tableName: ParticipantSupportedAcElements
            columnName: participantId

  - changeSet:
      id: 1701-31
      author: policy
      changes:
        - addDefaultValue:
            tableName: ParticipantSupportedAcElements
            columnName: typeName
            defaultValue: ''
        - update:
            tableName: ParticipantSupportedAcElements
            columns:
              - column:
                  name: typeName
                  value: ''
            where: typeName IS NULL
        - addNotNullConstraint:
            tableName: ParticipantSupportedAcElements
            columnName: typeName

  - changeSet:
      id: 1701-32
      author: policy
      changes:
        - addDefaultValue:
            tableName: ParticipantSupportedAcElements
            columnName: typeVersion
            defaultValue: '1.0.0'
        - update:
            tableName: ParticipantSupportedAcElements
            columns:
              - column:
                  name: typeVersion
                  value: '1.0.0'
            where: typeVersion IS NULL
        - addNotNullConstraint:
            tableName: ParticipantSupportedAcElements
            columnName: typeVersion
