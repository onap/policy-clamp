# ============LICENSE_START=======================================================
# Copyright (C) 2025 OpenInfra Foundation Europe. All rights reserved.
# ================================================================================
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0
# ============LICENSE_END=========================================================

databaseChangeLog:
  - objectQuotingStrategy: QUOTE_ONLY_RESERVED_WORDS

  - changeSet:
      id: 1701-1
      author: policy
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: automationcompositionrollback
      changes:
        - sql:
            sql: |
              CREATE TABLE automationcompositionrollback (
                instanceId VARCHAR(255) NOT NULL,
                compositionId VARCHAR(255) NOT NULL,
                elements TEXT NOT NULL,
                CONSTRAINT PK_AUTOMATIONCOMPOSITION_ROLLBACK PRIMARY KEY (instanceId)
              );

  - changeSet:
      id: 1701-2
      author: policy
      changes:
        - sql:
            sql: |
              UPDATE automationcomposition SET deployState = 2 WHERE deployState IS NULL;
              UPDATE automationcomposition SET lockState = 4 WHERE lockState IS NULL;
              UPDATE automationcomposition SET name = '' WHERE name IS NULL;
              UPDATE automationcomposition SET version = '1.0.0' WHERE version IS NULL;
              UPDATE automationcomposition SET lastMsg = now() WHERE lastMsg IS NULL;
              UPDATE automationcomposition SET subState = 0 WHERE subState IS NULL;

              ALTER TABLE automationcomposition ALTER COLUMN compositionid SET NOT NULL;
              ALTER TABLE automationcomposition ALTER COLUMN name SET DEFAULT '';
              ALTER TABLE automationcomposition ALTER COLUMN name SET NOT NULL;
              ALTER TABLE automationcomposition ALTER COLUMN version SET DEFAULT '1.0.0';
              ALTER TABLE automationcomposition ALTER COLUMN version SET NOT NULL;
              ALTER TABLE automationcomposition ALTER COLUMN deployState SET DEFAULT 2;
              ALTER TABLE automationcomposition ALTER COLUMN deployState SET NOT NULL;
              ALTER TABLE automationcomposition ALTER COLUMN lockState SET DEFAULT 4;
              ALTER TABLE automationcomposition ALTER COLUMN lockState SET NOT NULL;
              ALTER TABLE automationcomposition ALTER COLUMN SubState SET DEFAULT 0;
              ALTER TABLE automationcomposition ALTER COLUMN SubState SET NOT NULL;
              ALTER TABLE automationcomposition ALTER COLUMN lastMsg SET NOT NULL;

  - changeSet:
      id: 1701-3
      author: policy
      changes:
        - sql:
            sql: |
              UPDATE automationcompositionelement SET definition_name = '' WHERE definition_name IS NULL;
              UPDATE automationcompositionelement SET definition_version = '0.0.0' WHERE definition_version IS NULL;
              UPDATE automationcompositionelement SET deploystate = 2 WHERE deploystate IS NULL;
              UPDATE automationcompositionelement SET lockState = 4 WHERE lockState IS NULL;
              UPDATE automationcompositionelement SET subState = 0 WHERE subState IS NULL;

              ALTER TABLE automationcompositionelement ALTER COLUMN definition_name SET NOT NULL;
              ALTER TABLE automationcompositionelement ALTER COLUMN definition_name SET DEFAULT '';
              ALTER TABLE automationcompositionelement ALTER COLUMN definition_version SET NOT NULL;
              ALTER TABLE automationcompositionelement ALTER COLUMN definition_version SET DEFAULT '0.0.0';
              ALTER TABLE automationcompositionelement ALTER COLUMN deploystate SET NOT NULL;
              ALTER TABLE automationcompositionelement ALTER COLUMN deployState SET DEFAULT 2;
              ALTER TABLE automationcompositionelement ALTER COLUMN lockState SET NOT NULL;
              ALTER TABLE automationcompositionelement ALTER COLUMN lockState SET DEFAULT 4;
              ALTER TABLE automationcompositionelement ALTER COLUMN substate SET NOT NULL;
              ALTER TABLE automationcompositionelement ALTER COLUMN substate SET DEFAULT 0;
              ALTER TABLE automationcompositionelement ALTER COLUMN outproperties SET NOT NULL;
              ALTER TABLE automationcompositionelement ALTER COLUMN outproperties SET DEFAULT '{}';
              ALTER TABLE automationcompositionelement ALTER COLUMN properties SET NOT NULL;
              ALTER TABLE automationcompositionelement ALTER COLUMN properties SET DEFAULT '{}';

  - changeSet:
      id: 1701-4
      author: policy
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: ac_composition_fk
                foreignKeyTableName: automationcomposition
      changes:
        - sql:
            sql: |
              ALTER TABLE automationcomposition
                ADD CONSTRAINT ac_composition_fk
                FOREIGN KEY (compositionId)
                REFERENCES automationcompositiondefinition (compositionId)
                ON UPDATE RESTRICT
                ON DELETE RESTRICT;

  - changeSet:
      id: 1701-5
      author: policy
      changes:
        - sql:
            sql: |
              UPDATE automationcompositiondefinition SET name = '' WHERE name IS NULL;
              UPDATE automationcompositiondefinition SET version  = '1.0.0' WHERE version IS NULL;
              UPDATE automationcompositiondefinition SET state  = 0 WHERE state IS NULL;
              UPDATE automationcompositiondefinition SET lastMsg = now() WHERE lastMsg IS NULL;
              UPDATE automationcompositiondefinition SET serviceTemplate = '' WHERE serviceTemplate IS NULL;

              ALTER TABLE automationcompositiondefinition ALTER COLUMN name SET NOT NULL;
              ALTER TABLE automationcompositiondefinition ALTER COLUMN name SET DEFAULT '';
              ALTER TABLE automationcompositiondefinition ALTER COLUMN version SET NOT NULL;
              ALTER TABLE automationcompositiondefinition ALTER COLUMN version SET DEFAULT '1.0.0';
              ALTER TABLE automationcompositiondefinition ALTER COLUMN state SET NOT NULL;
              ALTER TABLE automationcompositiondefinition ALTER COLUMN state SET DEFAULT 0;
              ALTER TABLE automationcompositiondefinition ALTER COLUMN serviceTemplate SET NOT NULL;
              ALTER TABLE automationcompositiondefinition ALTER COLUMN serviceTemplate SET DEFAULT '';
              ALTER TABLE automationcompositiondefinition ALTER COLUMN lastMsg SET NOT NULL;

  - changeSet:
      id: 1701-6
      author: policy
      changes:
        - sql:
            sql: |
              UPDATE nodetemplatestate SET nodeTemplate_name  = '' WHERE nodeTemplate_name IS NULL;
              UPDATE nodetemplatestate SET nodeTemplate_version = '1.0.0' WHERE nodeTemplate_version IS NULL;
              UPDATE nodetemplatestate SET outProperties = '{}' WHERE outProperties IS NULL;
              UPDATE nodetemplatestate SET state = 0 WHERE state IS NULL;

              ALTER TABLE nodetemplatestate ALTER COLUMN nodeTemplate_name SET NOT NULL;
              ALTER TABLE nodetemplatestate ALTER COLUMN nodeTemplate_name SET DEFAULT '';
              ALTER TABLE nodetemplatestate ALTER COLUMN nodeTemplate_version SET NOT NULL;
              ALTER TABLE nodetemplatestate ALTER COLUMN nodeTemplate_version SET DEFAULT '1.0.0';
              ALTER TABLE nodetemplatestate ALTER COLUMN outProperties SET NOT NULL;
              ALTER TABLE nodetemplatestate ALTER COLUMN outProperties SET DEFAULT '{}';
              ALTER TABLE nodetemplatestate ALTER COLUMN state SET NOT NULL;
              ALTER TABLE nodetemplatestate ALTER COLUMN state SET DEFAULT 0;

  - changeSet:
      id: 1701-7
      author: policy
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: mb_identificationId_index
      changes:
        - sql:
            sql: CREATE INDEX mb_identificationId_index ON message(identificationId);

  - changeSet:
      id: 1701-8
      author: policy
      changes:
        - sql:
            sql: |
              UPDATE participantreplica SET lastMsg = now() WHERE lastMsg IS NULL;
              UPDATE participantreplica SET participantState = '1' WHERE participantState IS NULL;

              ALTER TABLE participantreplica ALTER COLUMN lastMsg SET NOT NULL;
              ALTER TABLE participantreplica ALTER COLUMN participantId SET NOT NULL;
              ALTER TABLE participantreplica ALTER COLUMN participantId SET DEFAULT '';
              ALTER TABLE participantreplica ALTER COLUMN participantState SET NOT NULL;
              ALTER TABLE participantreplica ALTER COLUMN participantState SET DEFAULT 1;

  - changeSet:
      id: 1701-9
      author: policy
      changes:
        - sql:
            sql: |
              UPDATE participantsupportedacelements SET typeName = '' WHERE typeName IS NULL;
              UPDATE participantsupportedacelements SET typeVersion = '1.0.0' WHERE typeVersion IS NULL;

              ALTER TABLE participantsupportedacelements ALTER COLUMN participantId SET NOT NULL;
              ALTER TABLE participantsupportedacelements ALTER COLUMN participantId SET DEFAULT '';
              ALTER TABLE participantsupportedacelements ALTER COLUMN typeName SET NOT NULL;
              ALTER TABLE participantsupportedacelements ALTER COLUMN typeName SET DEFAULT '';
              ALTER TABLE participantsupportedacelements ALTER COLUMN typeVersion SET NOT NULL;
              ALTER TABLE participantsupportedacelements ALTER COLUMN typeVersion SET DEFAULT '1.0.0';
